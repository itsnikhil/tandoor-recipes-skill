name: Build and Deploy to Main

on:
  push:
    branches: [develop]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Build TypeScript
        working-directory: ./scripts
        run: npm run build

      - name: Prepare artifacts
        run: |
          # Save built files to temp location
          mkdir -p /tmp/deploy/scripts
          mkdir -p /tmp/deploy/references
          
          cp SKILL.md /tmp/deploy/
          cp -r references/* /tmp/deploy/references/
          cp scripts/build/*.js /tmp/deploy/scripts/
          cp scripts/build/*.d.ts /tmp/deploy/scripts/
          cp scripts/build/*.map /tmp/deploy/scripts/
          cp scripts/package.json /tmp/deploy/scripts/
          
          # Update paths in SKILL.md
          sed -i 's|./scripts/build/|./scripts/|g' /tmp/deploy/SKILL.md

      - name: Deploy to main branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create fresh orphan main branch
          git checkout --orphan temp-main
          git rm -rf .
          
          # Copy prepared artifacts
          cp -r /tmp/deploy/* .
          
          # Commit and force push
          git add -A
          git commit -m "build: update from develop (${{ github.sha }})"
          git push origin temp-main:main --force
